# Implementation Details: acstuff.ru Link Capture

## Overview

This document explains how the AC Server Manager captures and displays the acstuff.ru connection link generated by the Assetto Corsa server.

## Problem

When an Assetto Corsa server starts, it generates a unique acstuff.ru link that players use to connect via Content Manager. This link needs to be captured and displayed to the user for sharing with players.

## Solution Architecture

### 1. Server Deployment Flow

```
User runs: ac-deploy deploy pack.zip
    â†“
Upload pack to S3
    â†“
Launch Windows EC2 instance with user data script
    â†“
User data script runs PowerShell automation:
    - Downloads pack from S3
    - Extracts to C:\acserver
    - Finds acServer.exe
    - Starts server via scheduled task
    - Monitors logs for acstuff.ru link
    - Saves info to C:\ac-server-info\server-info.txt
    â†“
Python code retrieves server info via AWS SSM
    â†“
Displays acstuff.ru link to user
```

### 2. Key Components

#### PowerShell User Data Script (ec2.py:create_user_data_script)

The script performs these critical tasks:

1. **Download and Extract Pack**
   ```powershell
   Invoke-WebRequest -Uri $downloadUrl -OutFile $packPath
   Expand-Archive -Path $packPath -DestinationPath $extractPath -Force
   ```

2. **Find acServer.exe**
   ```powershell
   $acServerPath = Get-ChildItem -Path $extractPath -Filter "acServer.exe" -Recurse
   ```

3. **Create Monitor Script**
   - Starts acServer.exe with output redirection
   - Monitors log file for patterns:
     - `http://acstuff.(ru|com)/[^\s]+`
     - `PAGE URL: (.+)`
   - Checks every 2 seconds for up to 60 attempts (2 minutes)
   - Writes captured link to server-info.txt

4. **Scheduled Task**
   - Creates Windows scheduled task to start on boot
   - Runs with SYSTEM privileges
   - Ensures server persists across reboots

#### Server Info Retrieval (ec2.py:get_server_info)

Uses AWS Systems Manager (SSM) to remotely read the server info file:

```python
def get_server_info(self, instance_id: str, max_attempts: int = 30):
    # Send SSM command to read server-info.txt
    response = self.ssm_client.send_command(
        InstanceIds=[instance_id],
        DocumentName="AWS-RunPowerShellScript",
        Parameters={"commands": ["Get-Content C:\\ac-server-info\\server-info.txt"]}
    )
    
    # Parse output into dictionary
    # Returns: {
    #   "AC_SERVER_LINK": "http://acstuff.ru/s/q/abc123",
    #   "SERVER_STATUS": "RUNNING",
    #   "PROCESS_ID": "1234",
    #   "PUBLIC_IP": "1.2.3.4",
    #   ...
    # }
```

#### Deployment Orchestration (deployer.py:deploy)

Coordinates the entire deployment:

```python
def deploy(self, pack_path: Path, instance_name: Optional[str] = None):
    # 1. Upload pack to S3
    pack_key = self.s3_manager.upload_pack(pack_path)
    
    # 2. Create security group with AC ports
    security_group_id = self.ec2_manager.create_security_group(...)
    
    # 3. Launch instance with user data script
    instance_id = self.ec2_manager.launch_instance(...)
    
    # 4. Wait for and retrieve server info (including link)
    server_info = self.ec2_manager.get_server_info(instance_id, max_attempts=60)
    
    # 5. Extract and return acstuff.ru link
    if "AC_SERVER_LINK" in server_info:
        return {"acstuff_link": server_info["AC_SERVER_LINK"], ...}
```

### 3. Server Verification

The implementation ensures the server is actually running:

1. **Process Monitoring**
   - Checks if acServer.exe process has exited
   - Captures exit code if process fails
   - Reports RUNNING or EXITED status

2. **Log Capture**
   - Redirects stdout to `C:\ac-server-log.txt`
   - Redirects stderr to `C:\ac-server-error.txt`
   - Available for debugging via RDP

3. **Persistent Storage**
   - Saves all info to `C:\ac-server-info\server-info.txt`
   - Includes:
     - AC_SERVER_LINK
     - SERVER_STATUS
     - PROCESS_ID
     - PUBLIC_IP
     - HTTP_PORT, TCP_PORT

### 4. Security Configuration

Security group allows necessary traffic:

- **TCP 9600**: AC server game traffic
- **UDP 9600**: AC server game traffic
- **TCP 8081**: AC server HTTP interface
- **TCP 3389**: RDP for management/debugging

### 5. Cost Optimization

- **Instance**: t3.small ($0.0208/hr)
  - 2 vCPUs, 2 GB RAM
  - Sufficient for 2-8 players
  - Can be stopped when not in use (only storage costs apply)

- **Storage**: S3 Standard
  - Pay per GB stored
  - Can use lifecycle policies to delete old packs

- **Data Transfer**: Mostly free for inbound
  - Outbound charged per GB

## Usage Examples

### Deploy and Get Link

```bash
$ ac-deploy deploy server-pack.zip

ðŸš€ Deploying AC server from server-pack.zip...
...
âœ… Deployment successful!
Instance ID: i-0123456789abcdef0
Public IP: 54.123.45.67

ðŸŽ® Server Connection Link:
   http://acstuff.ru/s/q/abc123defg

Share this link with players to connect via Content Manager!

Ports:
   HTTP: 8081
   TCP: 9600
   UDP: 9600
```

### Check Status Later

```bash
$ ac-deploy status i-0123456789abcdef0

ðŸ“Š Server Status for i-0123456789abcdef0:

State: running
Type: t3.small
Public IP: 54.123.45.67

Server Information:
  AC_SERVER_LINK: http://acstuff.ru/s/q/abc123defg
  SERVER_STATUS: RUNNING
  PROCESS_ID: 2468
  PUBLIC_IP: 54.123.45.67
  HTTP_PORT: 8081
  TCP_PORT: 9600

ðŸŽ® Connect via: http://acstuff.ru/s/q/abc123defg
```

## Troubleshooting

### Link Not Captured

If the link doesn't appear:

1. **Wait Longer**: Server startup can take 3-5 minutes
2. **Check Logs via RDP**:
   - Connect to instance IP:3389
   - Check `C:\ac-deployment.log` for setup
   - Check `C:\ac-server-log.txt` for server output
   - Check `C:\ac-server-info\server-info.txt` for captured data

3. **Verify Pack Contents**:
   - Ensure acServer.exe is in the pack
   - Ensure cfg/server_cfg.ini is properly configured
   - Ensure all required content (tracks/cars) is present

### Server Not Running

Check server status file content:
- `SERVER_STATUS=EXITED` means the server crashed
- `EXIT_CODE=X` indicates why it exited
- Check error log at `C:\ac-server-error.txt`

Common issues:
- Missing or invalid server_cfg.ini
- Missing track or car content
- Port conflicts (rare on fresh instance)

## Future Enhancements

Potential improvements:

1. **CloudWatch Logs Integration**: Stream logs to CloudWatch for easier access
2. **Auto-Restart on Crash**: Monitor and restart server if it fails
3. **Discord Webhook**: Send link to Discord channel automatically
4. **Multiple Servers**: Support for running multiple AC servers on one instance
5. **Metrics**: Track player count, session duration, etc.

